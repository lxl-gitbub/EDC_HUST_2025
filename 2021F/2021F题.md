# 2021F题

## 硬件选择：

### 小车1

- 校赛用小车
- STM32H743
- TB6612FNG（自购驱动板）
- 3000mah电池
- 八路红外传感器
- IMU601陀螺仪（加面包板）
- K230摄像头模块
- 红外光电对管
- HC-05蓝牙模块
- 红绿灯三色led模块

### 小车2

- 校购两轮差速小车
- STM32H743
- TB6612FNG（校购单驱动芯片）（加面包板）
- 11.1V三节快充电池
- 八路灰度蓝光传感器
- JY61P陀螺仪
- K230摄像头模块
- 红外光电对管
- HC-05蓝牙模块
- 红绿灯三色led模块

## 工程配置

### 电机、编码器（A是右轮， B是左轮）：

重要提醒：非必要不重组线，重连线一定看准方向，不要左轮搞右轮，右轮搞左轮, 不确定方向要全部重测

**tim5 c1/2 PWM输出，prescaler 24-1，counter period 1000-1**

- pwma--pa0--TIM5 CHAN1

- pwmb--pa1--TIM5 CHAN2

**GPIO output    level:low  mode:pushpull  no pull-up/pull-down**

ain2--pc5

ain1--pb1

bin1--pb0

bin2--pc4

**tim1/3 Encoder Mode**

e1a--pe11

e1b--pe9

e2a--pa6

e2b--pa7


**以下关于tx与rx的说明，都是指工程配置为tx或rx，而不是指接线，例如pc6--tx，实际上需要连接八路传感器的rx**
**为了方便期间，不建议把tx和rx用统一颜色的线**

### 灰度传感器

 USART6  pc6--tx  pc7--rx

 KEY--PB15 gpio-input pull-up 

### 陀螺仪

USART2  pa2--tx  pa3--rx

利用tim6产生的1us定时来实现功能



### 摄像头（先接串口）

USART1  pa9--tx  pa10--rx



### 蓝牙模块

USART3  pb10--tx  pb11--rx



### 蜂鸣器

接了，但不用



### 红绿灯模块

PD1--GND

PD2--Red

PD3--Yellow

PD4--Green



### 红外对光灯管

3v3 GND input*1





# 主程序逻辑：

### 基本要求状态表：

1. 识别数字并放药（红外光管、摄像头）
2. 直线前进(八路巡线、电机)
   - 中端远端还需要编码器+摄像头来识别病房号
3. 直角前进+转弯（陀螺仪、电机、编码器）
4. 停车（八路巡线、电机、led）
5. 取药（红外光管、led）
6. 送完药掉头（陀螺仪、电机）
7. 回城（通过前面记录的转向数据来对应直角前进、转弯）

- T1：小车在放上物品一秒后，跟着巡线来先走直线。等到走到直角时（三岔路口），根据编码器开始从0计算运动距离，等到运动距离到20cm后，向相应方向做90度转弯（陀螺仪引导），（重复一次），待到位后停车、变色。等待放下物品后，掉头，沿原路线返回，停车变色

- T2：小车在放上物品一秒后，跟着巡线来先走直线。等到走到第一个直角时（三岔路口），启动编码器开始从0计算运动距离，等到运动距离到60cm（待调试）后，启动视觉识别判断（需要的编号位列从左到右第几个），再当经过直角（三岔路口）后根据需要继续直行或在运动20cm后向相应方向做90度转弯（陀螺仪引导），再重复一次转弯，待到位后停车、变色。等待放下物品后，掉头，沿原路线返回，停车变色
- T3：小车在放上物品一秒后，跟着巡线来先走直线。等到走到第二个直角时（三岔路口），根据编码器开始从0计算运动距离，等到运动距离到60cm（待确认）后，启动视觉识别判断（需要的编号位列从左到右第几个），再在直角（三岔路口）运动20cm后向相应方向做90度转弯（陀螺仪引导），再重复一次编码器计算距离+视觉识别+直角转弯，待到位后停车、变色。等待放下物品后，掉头，沿原路线返回，停车变色

### 提高要求1：

- 小车1：
  1. 识别数字并放药（红外光管、摄像头）
  2. 直线前进(八路巡线、电机、编码器、摄像头)
  3. 直角前进+转弯（陀螺仪、电机、编码器）
  4. 停车（八路巡线、电机、led、**发出蓝牙信号1**）
  5. **收到蓝牙信号2**并取走药（红外光管、led）
  6. 送完药掉头（陀螺仪、电机）
  7. 回城（通过前面记录的转向数据来对应直角前进、转弯，并适时**发出信号3**）
- 小车2：
  1. **收到蓝牙信号1**并识别数字并放药
  2. 直线前进(八路巡线、电机、编码器、摄像头)
  3. 直角前进+转弯（陀螺仪、电机、编码器）+**运动一段短距离后停车亮灯，发出信号2**
  4. **收到信号3**后掉头，继续按路线运送，到达病房停车亮灯

### 提高要求2：

- 小车1：
  1. 识别数组并放药（红外光管、摄像头）
  2. 直线前进(八路巡线、电机、编码器、摄像头)
  3. 直角前进+转弯（陀螺仪、电机、编码器）
  4. 停车（八路巡线、电机、led）
  5. 取走药后**发出蓝牙信号1**，并开始沿原路返回，到远端三岔路口前一段停车
  6. **待收到蓝牙信号2**，继续直线前进、转弯（一段距离后**发出蓝牙信号3**、回城、亮灯
- 小车2：
  1. 识别数字后等待**收到蓝牙信号1**
  2. 直线前进
  3. 直角前进+转弯（关于远端目标病房反方向）
  4. 移动一段距离后**并发出蓝牙信号2**并同时调头
  5. 等待**接收蓝牙信号3**后直线前进、转弯、到达病房，亮灯
